<html>

<style>

body{
    background-color: black;
    color:white;
}

.ok {
   color:green;
   display: none;
}
.failed {
   color:red;
   display: none;
}

.green {
    color:green;
}
.red {
    color:red;
}

#input{
    border: 1px solid grey;
}

input { 
    text-align: center; 
}

button {
    margin-right: 10px;
}

span {
    display: table-cell;
    width: 60%;
}

#failed_deploy{
    background-color: #CC0000;
    border: 2px solid #CC3333;
    padding: 5px;
}

#next_step{
    background-color: #009900;
    border: 2px solid #006600;
    padding: 5px;
}

.explanation {
    border: 1px solid grey;
    margin-bottom: 15px;
    padding: 5px;

}

</style>

<script src="framework.js" ></script>
<script src="random.js" ></script>
<script src="input.js" ></script>
<script src="rules.js" ></script>
<script src="engine.js" ></script>
<script src="functional_tests.js" ></script>


<div id="explanation" class="explanation">
    <b>Explication : </b>
    Vous êtes un développeur. Votre trvavail consiste à prendre des règles et à écrire un programme qui respecte ces règles.<br/>
    Vous trouverez les règles ci-dessous et vous pourrez écrire votre programme en remplissant la grille de droite avec les lettres appropriées.<br/><br/>
    La plupart des règles sont évidentes, deux précisions cependant :
    <lu>
        <li><i>Un X à côté d'un Y (4 directions)</i> signifie en haut, bas, droite ou gauche mais pas en diagonales</li>
        <li><i>Un X à un saut de cheval d'un Y</i> signifie un déplacement de deux cases dans une direction suivi d'un déplacement de une case dans l'autre direction (comme aux échecs). Par exemple : 2 cases vers le haut suivi d'une case vers la droite.</li>
    </lu>
    <br/>
    Une fois que vous avez bien tout programmé, cliquez le bouton au bas des règles pour mettre votre programme en production (et voir si vous avez bien respecté toutes les règles)
</div>

<div id="explanation_manual" class="explanation">
    <b>Explication : </b>
    Maintenant vous avez la chance d'avoir des tests... <br/>
    Malheureusement nous n'avons pas fait l'effort de les automatiser, il va falloir les exécuter à la main.<br/>
    Pour executer un test, cliquez sur le bouton, la ligne devient verte si le test est passé avec succès, rouge dans le cas contraire.
</div>

<div id="explanation_auto" class="explanation">
    <b>Explication : </b>
    Maintenant vous avez la chance d'avoir des tests et ils se lancent automatiquement a chaque modification du code !
    La ligne devient verte si le test est passé avec succès, rouge dans le cas contraire.
</div>

<div>
    <span>
        Voici les règles :
        <ul id ="rules"></ul>
        <input id="pushToProd" type=button value="Mettre en PROD !" onclick="pushToPROD()" />
    </span>
    <span>
       Programmez votre réponse :
        <table id ="input"></table>
    </span>
</div>

<div id="next_step" style="display:none">
    Félicitations ! la mise en PROD s'est bien passée !
    <input type=button id="next_step_url" value="Etape suivante !" onclick="redirectToNextStep()"/>

</div>

<div id="failed_deploy"  style="display:none">
    Les utilisateurs sont super fachés ! <br/>
    Le système ne fonctionne plus... <br/>
    <span id="failed_rule"></span>
</div>


<script>

const queryString = window.location.search;
const urlParams = new URLSearchParams(queryString);
const step = urlParams.get('step')
if(step == undefined) {
    window.location.replace("?step=NO_TEST");
}

var seed = urlParams.get('seed')
if(seed == undefined) {
    if(step == "NO_TEST"){
        seed = 1598764;
    }else{
        if (step == "MANUAL_TEST"){
            seed = 365489;
        } else {
            seed = 4896320;
        }
    }
}

if(step == "NO_TEST"){
    document.getElementById("explanation_manual").style.display="none";
    document.getElementById("explanation_auto").style.display="none";
}

if(step == "AUTO_TEST"){
    document.getElementById("next_step_url").style.display="none";
    document.getElementById("explanation").style.display="none";
    document.getElementById("explanation_manual").style.display="none";
    
}
if(step == "MANUAL_TEST"){
    document.getElementById("explanation").style.display="none";
    document.getElementById("explanation_auto").style.display="none";
}

function refreshRules(game){
    var ruleList = document.getElementById("rules");
    while (ruleList.firstChild) {
        ruleList.removeChild(ruleList.lastChild);
    }
    for(const rule of game.get_rules_with_status()){
        const node = document.createElement("li");
        const textnode = document.createTextNode(rule[0]);
        
        var color = "red";
        if(rule[1]) color = "green";
        if (step == "AUTO_TEST"){
            node.classList.add(color);
        }
        
        
        if (step == "MANUAL_TEST"){
            const buttonnode = document.createElement("button")
            buttonnode.innerHTML = "Manual test";
            if(rule[1]) {
                buttonnode.onmousedown = () => node.classList.add("green");
                buttonnode.onmouseup = () => node.classList.remove("green");
                buttonnode.onmouseout = () => node.classList.remove("green");
            }else{
                buttonnode.onmousedown = () => node.classList.add("red");
                buttonnode.onmouseup = () => node.classList.remove("red");
                buttonnode.onmouseout = () => node.classList.remove("red");
            }
            node.appendChild(buttonnode);
        }
        node.appendChild(textnode);
        
        ruleList.appendChild(node);
    }   
}

generator = new RulesGenerator(seed);
rules = [
    generator.generate_rule(),
    generator.generate_rule(),
    generator.generate_rule(),
    generator.generate_rule(),
    generator.generate_rule(),
    generator.generate_rule(),
    generator.generate_rule(),
    generator.generate_rule(),
    generator.generate_rule(),
    generator.generate_rule(),
    generator.generate_rule(),
    generator.generate_rule(),
    generator.generate_rule(),
    generator.generate_rule(),
    generator.generate_rule(),
    generator.generate_rule()
]
const input = new Input(5,5);
const game = new Engine(rules, input);

refreshRules(game);


function changeEvent(x, y){
    return (event) => {
      input.set_element(x, y, event.target.value);
      refreshRules(game);
    }
}

var inputTable = document.getElementById("input");
for(var y = 0; y < input.height; y ++){
    var row = document.createElement("tr");
    for(var x = 0; x < input.width; x ++){
        var cell = document.createElement("td");
        var charInput = document.createElement("input");
        cell.appendChild(charInput);
        charInput.maxLength = 1;
        charInput.size = 1;
        cell.addEventListener('keyup', changeEvent(x, y) );
        row.appendChild(cell);
    }
    inputTable.appendChild(row);
}

function pushToPROD(){
    var failed_deploy = document.getElementById("failed_deploy");
   
    failed_deploy.style.display = "none";
    
    if (game.is_green()){
        var next_step = document.getElementById("next_step");
        next_step.style.display = "block";
        var pushToProdButton = document.getElementById("pushToProd");
        pushToProdButton.style.display = "none";
        
        
    }else{
        failed_deploy.style.display = "block";
        var failed_rule = document.getElementById("failed_rule");
        failed_rule.innerHTML = "Il faut vite corriger la règle : " + game.get_rules_with_status().filter(x => x[1]==false)[0][0];
    }
}

function redirectToNextStep(){
    if(step == "NO_TEST"){
            window.location.replace("?step=MANUAL_TEST");
    }
    if(step == "MANUAL_TEST"){
        window.location.replace("?step=AUTO_TEST");
    }
    }
</script>



</html>